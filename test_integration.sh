#!/bin/bash

echo "üîç TESTING WOMEN SAFETY APP INTEGRATION"
echo "========================================"
echo ""

# Check if database exists
DB_PATH="backend/core/threat_logs.db"
if [ -f "$DB_PATH" ]; then
    echo "‚úÖ Database found: $DB_PATH"
else
    echo "‚ùå Database NOT found at: $DB_PATH"
    echo "   Run the backend server first: cd backend && python3 main.py"
    exit 1
fi

echo ""
echo "üìä DATABASE TABLES:"
echo "-------------------"
sqlite3 "$DB_PATH" ".tables"

echo ""
echo "üìû EMERGENCY CONTACTS COUNT:"
echo "----------------------------"
sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM emergency_contacts;" | while read count; do
    echo "Total Contacts: $count"
done

echo ""
echo "üìû EMERGENCY CONTACTS LIST:"
echo "---------------------------"
sqlite3 "$DB_PATH" "SELECT id, name, phone_number, is_primary FROM emergency_contacts ORDER BY is_primary DESC, name ASC;" | while IFS='|' read id name phone primary; do
    if [ "$primary" = "1" ]; then
        echo "  ‚≠ê ID:$id | $name | $phone (PRIMARY)"
    else
        echo "  üì± ID:$id | $name | $phone"
    fi
done

echo ""
echo "üö® THREAT LOGS COUNT:"
echo "---------------------"
sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM threat_logs;" | while read count; do
    echo "Total Logs: $count"
done

echo ""
echo "üö® RECENT THREAT LOGS (Last 5):"
echo "--------------------------------"
sqlite3 "$DB_PATH" "SELECT timestamp, threat_level, threat_score FROM threat_logs ORDER BY id DESC LIMIT 5;" | while IFS='|' read timestamp level score; do
    if [ "$level" = "HIGH" ]; then
        echo "  üî¥ $timestamp | $level | Score: $score"
    elif [ "$level" = "MEDIUM" ]; then
        echo "  üü° $timestamp | $level | Score: $score"
    else
        echo "  üü¢ $timestamp | $level | Score: $score"
    fi
done

echo ""
echo "‚öôÔ∏è  SETTINGS:"
echo "-------------"
sqlite3 "$DB_PATH" "SELECT key, value FROM settings;" | while IFS='|' read key value; do
    echo "  $key: $value"
done

echo ""
echo "üì± AUTO-ALERTS COUNT:"
echo "---------------------"
sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM auto_alerts;" | while read count; do
    echo "Total Auto-Alerts Sent: $count"
done

echo ""
echo "üîó INTEGRATION CHECK:"
echo "---------------------"

# Check backend files
if [ -f "backend/main.py" ]; then
    echo "‚úÖ Backend main.py exists"
    BACKEND_CONTACTS=$(grep -c "get_emergency_contacts" backend/main.py)
    echo "   - Uses get_emergency_contacts: $BACKEND_CONTACTS times"
else
    echo "‚ùå Backend main.py NOT found"
fi

# Check frontend files
if [ -f "frontend/src/services/api.js" ]; then
    echo "‚úÖ Frontend api.js exists"
    FRONTEND_CONTACTS=$(grep -c "getEmergencyContacts" frontend/src/services/api.js)
    echo "   - Defines getEmergencyContacts: $FRONTEND_CONTACTS times"
else
    echo "‚ùå Frontend api.js NOT found"
fi

# Check Settings page
if [ -f "frontend/src/pages/Settings.jsx" ]; then
    echo "‚úÖ Frontend Settings.jsx exists"
    SETTINGS_IMPORT=$(grep -c "getEmergencyContacts" frontend/src/pages/Settings.jsx)
    echo "   - Uses getEmergencyContacts: $SETTINGS_IMPORT times"
else
    echo "‚ùå Frontend Settings.jsx NOT found"
fi

# Check CLI app
if [ -f "manage_contacts.py" ]; then
    echo "‚úÖ CLI app manage_contacts.py exists"
    echo "   - Same database: YES (uses backend/core/threat_logs.db)"
else
    echo "‚ùå CLI app NOT found"
fi

echo ""
echo "üéØ INTEGRATION STATUS:"
echo "----------------------"
echo "‚úÖ CLI App ‚Üê ‚Üí SQLite Database ‚Üê ‚Üí Backend API ‚Üê ‚Üí Frontend UI"
echo ""
echo "All components use the SAME database: $DB_PATH"
echo "Changes made in any component are visible in all others!"

echo ""
echo "üöÄ QUICK TESTS:"
echo "---------------"
echo "1. Add contact via CLI:     python3 manage_contacts.py"
echo "2. View in Frontend:        http://localhost:5173/settings"
echo "3. Check via Backend API:   curl http://127.0.0.1:8000/emergency/contacts"
echo "4. Test SOS:                curl -X POST http://127.0.0.1:8000/emergency/send-sos -H 'Content-Type: application/json' -d '{\"message\":\"Test\"}'"
echo ""
